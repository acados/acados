name: Test MATLAB on Windows

on:
  push:
    branches-ignore:
      - 'doc*'
      - 'wip*'
  pull_request:
    branches:
      - '*'

env:
  BUILD_TYPE: Release
  ACADOS_PYTHON: OFF # TODO ?
  ACADOS_OCTAVE: OFF # TODO ?
  ACADOS_WITH_OSQP: ON
  ACADOS_WITH_QPOASES: ON
  ACADOS_WITH_DAQP: ON
  ACADOS_WITH_QPDUNES: OFF
  ACADOS_ON_CI: ON

jobs:
  core_build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install Chocolatey
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force;
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072;
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

    - name: Install MinGW using Chocolatey
      run: |
        choco install mingw --yes

    - name: Add MinGW to PATH
      run: |
        echo "C:\tools\mingw64\bin" >> $env:MW_MINGW64_LOC

    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v2

    - name: Check GCC and CMake versions
      run: |
        which gcc
        gcc --version
        cmake --version

    - name: Install MATLAB
      uses: matlab-actions/setup-matlab@v2
      if: always()
      with:
          release: R2021a
          products: Simulink Simulink_Test
          cache: true

    - name: Setup MATLAB with MinGW Compiler
      uses: matlab-actions/run-command@v2
      if: always()
      with:
        command: |
            cd ${{runner.workspace}}/acados/.github/windows; setup_mingw

    - name: Install acados via MATLAB script
      uses: matlab-actions/run-command@v2
      if: always()
      with:
        command: |
            cd ${{runner.workspace}}/acados/interfaces/acados_matlab_octave; acados_install_windows

    - name: Run minimal MATLAB example
      uses: matlab-actions/run-command@v2
      if: always()
      with:
        command: |
            cd ${{runner.workspace}}/acados/.github/windows
            setup_mingw
            cd ${{runner.workspace}}/acados/examples/acados_matlab_octave
            acados_env_variables_windows
            cd getting_started
            minimal_example_ocp

    - name: Run CasADi MATLAB example
      uses: matlab-actions/run-command@v2
      if: always()
      with:
        command: |
            cd ${{runner.workspace}}/acados/examples/acados_matlab_octave/getting_started; minimal_casadi_example

