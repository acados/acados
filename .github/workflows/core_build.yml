name: Reusable Core Build

on:
  workflow_call:
    outputs:
      artifact-name-prefix:
        description: "The unique prefix for artifact names for this run"
        value: ${{ jobs.core_build.outputs.artifact-name-prefix }}

env:
  BUILD_TYPE: Release
  ACADOS_OCTAVE: ON
  ACADOS_WITH_OSQP: ON
  ACADOS_WITH_QPOASES: ON
  ACADOS_WITH_DAQP: ON
  ACADOS_WITH_QPDUNES: ON
  ACADOS_WITH_CLARABEL: ON
  ACADOS_ON_CI: ON


jobs:
  core_build:
    runs-on: ubuntu-22.04

    outputs:
      artifact-name-prefix: ${{ steps.vars.outputs.PREFIX }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Set up variables
      id: vars
      run: echo "PREFIX=build-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT

    - name: Check versions
      run: |
        cmake --version

    - name: Submodule fingerprint
      id: submods
      run: |
        set -euo pipefail
        git submodule status --recursive \
          | awk '{print $1 " " $2}' \
          | sed 's/^[-+ ]*//' \
          | sort -k2,2 \
          | sha256sum | cut -d' ' -f1 > submods.sha
        echo "sha=$(cat submods.sha)" >> "$GITHUB_OUTPUT"

    - name: Cache Build Artifacts
      id: cache-build
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/build
          ${{ github.workspace }}/lib
          ${{ github.workspace }}/include
        key: ${{ runner.os }}-${{ env.BUILD_TYPE }}-acados-${{ steps.submods.outputs.sha }}-${{ hashFiles(
            '.gitmodules',
            'CMakeLists.txt',
            'cmake/**/*.cmake',
            'acados/**',
            '.github/workflows/core_build.yml',
            'interfaces/acados_c/**'
          ) }}

    - name: Install Eigen3, for clarabel
      if: env.ACADOS_WITH_CLARABEL == 'ON'
      run: sudo apt-get update && sudo apt-get install -y libeigen3-dev

    - name: Create Build Environment & Configure
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: |
        cmake -E make_directory ${{ github.workspace }}/build
        cd ${{ github.workspace }}/build
        cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DACADOS_WITH_QPOASES=$ACADOS_WITH_QPOASES \
            -DACADOS_WITH_DAQP=$ACADOS_WITH_DAQP \
            -DACADOS_WITH_QPDUNES=$ACADOS_WITH_QPDUNES \
            -DACADOS_WITH_OSQP=$ACADOS_WITH_OSQP \
            -DACADOS_WITH_CLARABEL=$ACADOS_WITH_CLARABEL \
            -DACADOS_OCTAVE=OFF \
            -DACADOS_WITH_OPENMP=ON \
            -DACADOS_NUM_THREADS=1

    - name: Build & Install
      if: steps.cache-build.outputs.cache-hit != 'true'
      working-directory: ${{ github.workspace }}/build
      run: |
        cmake --build . --config $BUILD_TYPE
        make install -j4

    - name: Store shared libs (/lib)
      uses: actions/upload-artifact@v4
      with:
        name: lib-${{ steps.vars.outputs.PREFIX }}
        path: ${{ github.workspace }}/lib/

    - name: Store build scripts (/build)
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ steps.vars.outputs.PREFIX }}
        path: |
          ${{ github.workspace }}/build/
          !${{ github.workspace }}/**/*.dir

    - name: Store include directory (/include)
      uses: actions/upload-artifact@v4
      with:
        name: include-${{ steps.vars.outputs.PREFIX }}
        path: ${{ github.workspace }}/include/
