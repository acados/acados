cmake_minimum_required(VERSION 3.8)
project({{ ros_opts.package_info.name }})

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# --- ROS DEPENDENCIES ---
find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(std_msgs REQUIRED)
find_package(rosidl_default_generators REQUIRED)
find_package(OpenMP REQUIRED)
{% for dep in ros_opts.dependencies %}
find_package({{ dep }} REQUIRED)
{% endfor %}

# --- INTERFACES (Generic State/Input + Service) ---
set(MSG_FILES
  "msg/State.msg"
  "msg/ControlInput.msg"
)

set(SRV_FILES
  "srv/SolveOCP.srv"
)

rosidl_generate_interfaces(${PROJECT_NAME}
  ${MSG_FILES}
  ${SRV_FILES}
  DEPENDENCIES std_msgs
)

# --- ACADOS PATHS ---
set(ACADOS_INCLUDE_PATH {{ acados_include_path }})
set(ACADOS_LIB_DIR {{ acados_lib_path }})
set(ACADOS_GENERATED_CODE_DIR {{ code_export_directory }})
set(ACADOS_GENERATED_LIB ${ACADOS_GENERATED_CODE_DIR}/libacados_ocp_solver_{{ model.name | lower }}{{ shared_lib_ext }})

# --- EXECUTABLE ---
add_executable({{ ros_opts.node_name }} 
    src/{{ ros_opts.node_name }}.cpp
)

# --- INCLUDE DIRECTORIES ---
include_directories(
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
    ${ACADOS_GENERATED_CODE_DIR}
    ${ACADOS_INCLUDE_PATH}
    ${ACADOS_INCLUDE_PATH}/acados
    ${ACADOS_INCLUDE_PATH}/blasfeo/include
    ${ACADOS_INCLUDE_PATH}/hpipm/include
    ${ACADOS_INCLUDE_PATH}/osqp
    ${ACADOS_INCLUDE_PATH}/qpOASES_e
)

# Include Directories
target_include_directories({{ ros_opts.node_name }} PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)
# Link Libraries
target_link_libraries({{ ros_opts.node_name }} 
    ${ACADOS_GENERATED_LIB}
    ${ACADOS_LIB_DIR}/libacados.so
    ${ACADOS_LIB_DIR}/libblasfeo.so
    ${ACADOS_LIB_DIR}/libhpipm.so
    ${ACADOS_LIB_DIR}/libosqp.so
    ${ACADOS_LIB_DIR}/libqpOASES_e.so
    m
    OpenMP::OpenMP_CXX
)

# --- DEPENDENCIES ---
set(COMMON_DEPENDENCIES 
    rclcpp
    std_msgs
    rosidl_default_runtime
    {% for dep in ros_opts.dependencies %}
    {{ dep }}
    {% endfor %}
)

ament_target_dependencies({{ ros_opts.node_name }} ${COMMON_DEPENDENCIES})

add_dependencies({{ ros_opts.node_name }}
    ${PROJECT_NAME}_rosidl_generated_interfaces
)

# --- INSTALLATIONS ---
install(FILES 
    ${ACADOS_GENERATED_LIB}
    DESTINATION lib
)

install(DIRECTORY 
    ${ACADOS_GENERATED_CODE_DIR}/
    DESTINATION include/${PROJECT_NAME}/generated_acados
)

install(DIRECTORY 
    include/
    DESTINATION include
)

install(TARGETS 
    {{ ros_opts.node_name }}
    RUNTIME DESTINATION lib/${PROJECT_NAME}
)

# --- EXPORTS ---
ament_export_include_directories(
    "include"
    ${ACADOS_INCLUDE_PATH}
    ${ACADOS_INCLUDE_PATH}/acados
    ${ACADOS_INCLUDE_PATH}/acados_c
    ${ACADOS_INCLUDE_PATH}/blasfeo/include
    ${ACADOS_INCLUDE_PATH}/hpipm/include
    ${ACADOS_INCLUDE_PATH}/osqp
    ${ACADOS_INCLUDE_PATH}/qpOASES_e
)

ament_export_libraries(
    acados_ocp_solver_{{ model.name | lower }}
    ${ACADOS_LIB_DIR}/libacados.so
    ${ACADOS_LIB_DIR}/libblasfeo.so
    ${ACADOS_LIB_DIR}/libhpipm.so
    ${ACADOS_LIB_DIR}/libosqp.so
    ${ACADOS_LIB_DIR}/libqpOASES_e.so
)

ament_export_dependencies(rosidl_default_runtime std_msgs)
ament_package()